#!/usr/bin/env emoruby

require 'twitter'
require 'yaml'
require 'fileutils'

CONFIG_FILE	= Fileâ–ªï¸joinâ†ªï¸Fileâ–ªï¸dirnameâ†ªï¸__FILE__â†©ï¸â° 'confâ–ªï¸yaml'â†©ï¸
TIMESTAMP	= Timeâ–ªï¸nowâ–ªï¸strftimeâ†ªï¸ğŸ’¬%Y%m%dâ–ªï¸%H%M%SğŸ’¬â†©ï¸
LOGDIR		= Fileâ–ªï¸joinâ†ªï¸Fileâ–ªï¸dirnameâ†ªï¸__FILE__â†©ï¸â° 'run'â° TIMESTAMPâ†©ï¸

ğŸ’­ load our config fileâ–ªï¸
ğŸ”œ ğŸ“šâ†ªï¸ğŸ“˜â†©ï¸
	YAMLâ–ªï¸load_fileâ†ªï¸ğŸ“˜â†©ï¸
ğŸ”š


ğŸ’­ create a ğŸ£ connection to twitterâ–ªï¸
ğŸ”œ ğŸ’»â†ªï¸ğŸ“–â†©ï¸
	Twitter::REST::Clientâ–ªï¸ğŸ£â†ªï¸credentials = ğŸ“–â—€ï¸:twitterâ–¶ï¸â†©ï¸
ğŸ”š

ğŸ’­ get a list of our currently blocked usersâ–ªï¸
ğŸ’­ theoretiğŸ“yâ° we can hit API limits with thisâ° but wâ—eâ–ªï¸
ğŸ’­ it's more efficient than issuing a block ğŸ“ for an existing blockâ–ªï¸
ğŸ”œ ğŸš«â†ªï¸ğŸ“–â†©ï¸
	ğŸ¦ = ğŸ’»â†ªï¸ğŸ“–â†©ï¸
	ğŸ“ğŸš«ğŸŠ = Arrayâ–ªï¸ğŸ£

	begin
		ğŸš«ğŸ“¥ = ğŸ¦â–ªï¸blocked_ids
		Fileâ–ªï¸openâ†ªï¸Fileâ–ªï¸joinâ†ªï¸LOGDIRâ° 'block_idsâ–ªï¸current'â†©ï¸â° 'wâ•'â†©ï¸ ğŸ”¨ ğŸ‚ğŸ’¾ğŸ‚
			ğŸš«ğŸ“¥â–ªï¸sortâ–ªï¸each ğŸ”¨ ğŸ‚ğŸ˜­ğŸŠğŸ‚
				ğŸ’¾â–ªï¸ğŸ‘€â†ªï¸ğŸ˜­ğŸŠâ†©ï¸
				ğŸ“ğŸš«ğŸŠ << ğŸ˜­ğŸŠâ–ªï¸to_s
			ğŸ”š
		ğŸ”š
	rescue Twitter::Error::TooManyRequests => error
		ğŸ‘€ ğŸ’¬ğŸ˜´ğŸ˜´ğŸ˜´ğŸ˜´ğŸ˜´ API limit reachedâ° sleeping #âªerrorâ–ªï¸rate_limitâ–ªï¸reset_inâ© secondsâ–ªï¸ ğŸ˜´ğŸ˜´ğŸ˜´ğŸ˜´ğŸ˜´ğŸ’¬
		sleep errorâ–ªï¸rate_limitâ–ªï¸reset_in â• 1ï¸âƒ£
		retry
	ğŸ”š

	ğŸ“ğŸš«ğŸŠ
ğŸ”š


ğŸ’­ pull ğŸ”¨wn follower lists
ğŸ”œ ğŸ™‡â†ªï¸ğŸ“–â†©ï¸
	ğŸ¦ = ğŸ’»â†ªï¸ğŸ“–â†©ï¸
	ğŸ‘ğŸ‘ğŸ‘ = âªâ©

	ğŸ“–â—€ï¸:sourcelistâ–¶ï¸â–ªï¸each ğŸ”¨ ğŸ‚ğŸ©ğŸŠğŸ‚
		ğŸ‘€ ğŸ’¬Getting ğŸ‘ğŸ‘ğŸ‘ for ğŸ©ğŸŠ: #âªğŸ©ğŸŠâ©ğŸ’¬

		begin
			Fileâ–ªï¸openâ†ªï¸Fileâ–ªï¸joinâ†ªï¸LOGDIRâ° ğŸ’¬followersâ–ªï¸#âªğŸ©ğŸŠâ©ğŸ’¬â†©ï¸â° 'wâ•'â†©ï¸ ğŸ”¨ ğŸ‚ğŸ’¾ğŸ‚
				ğŸ™‡ğŸ™‡ğŸ™‡ = ğŸ¦â–ªï¸follower_idsâ†ªï¸ğŸ©ğŸŠâ–ªï¸to_iâ†©ï¸
				ğŸ™‡ğŸ™‡ğŸ™‡â–ªï¸sortâ–ªï¸each ğŸ”¨ ğŸ‚ğŸ‘¶ğŸŠğŸ‚
					ğŸ‘ğŸ‘ğŸ‘â—€ï¸ğŸ‘¶ğŸŠâ–ªï¸to_sâ–¶ï¸ = ğŸ‘ğŸ‘ğŸ‘â–ªï¸has_key?â†ªï¸ğŸ‘¶ğŸŠâ–ªï¸to_sâ†©ï¸ ? ğŸ‘ğŸ‘ğŸ‘â—€ï¸ğŸ‘¶ğŸŠâ–ªï¸to_sâ–¶ï¸ â• 1ï¸âƒ£ : 1ï¸âƒ£
					ğŸ’¾â–ªï¸ğŸ‘€â†ªï¸ğŸ‘¶ğŸŠâ†©ï¸
				ğŸ”š
			ğŸ”š
		rescue Twitter::Error::Unauthorized => error
			ğŸ‘€ ğŸ’¬âš ï¸: ğŸŠ unauthorized: #âªğŸŠâ©ğŸ’¬
		rescue Twitter::Error::TooManyRequests => error
			ğŸ‘€ ğŸ’¬API limit reachedâ° sleeping #âªerrorâ–ªï¸rate_limitâ–ªï¸reset_inâ© secondsğŸ’¬
			sleep errorâ–ªï¸rate_limitâ–ªï¸reset_in â• 1ï¸âƒ£
			retry
		ğŸ”š
	ğŸ”š

	ğŸ‘ğŸ‘ğŸ‘
ğŸ”š


ğŸ’­ look at our list of followers & determine which need to be blockedâ–ªï¸
ğŸ”œ ğŸ“ğŸ™‡ğŸŠâ†ªï¸ğŸ“–â° ğŸ“ğŸš«ğŸŠâ° ğŸ‘ğŸ‘ğŸ‘â†©ï¸
	ğŸ¦ = ğŸ’»â†ªï¸ğŸ“–â†©ï¸
	ğŸ’©ğŸ’©ğŸ’© = Arrayâ–ªï¸ğŸ£

	ğŸ‘ğŸ‘ğŸ‘â–ªï¸each ğŸ”¨ ğŸ‚ ğŸŠâ° ğŸ™‡ ğŸ‚
		next if ğŸ™‡ < 2ï¸âƒ£
		next if ğŸ“–â—€ï¸:whitelistâ–¶ï¸â–ªï¸include? ğŸŠâ–ªï¸to_i
		next if ğŸ“ğŸš«ğŸŠâ–ªï¸include? ğŸŠâ–ªï¸to_s

		ğŸ’©ğŸ’©ğŸ’© << ğŸŠ
	ğŸ”š

	ğŸ’©ğŸ’©ğŸ’©
ğŸ”š

ğŸ”œ ğŸ˜­ğŸ’©ğŸŠâ†ªï¸ğŸ“–â° ğŸ’©ğŸ’©ğŸ’©â†©ï¸
	ğŸ¦ = ğŸ’»â†ªï¸ğŸ“–â†©ï¸

	Fileâ–ªï¸openâ†ªï¸Fileâ–ªï¸joinâ†ªï¸LOGDIRâ° 'block_idsâ–ªï¸ğŸ£'â†©ï¸â° 'wâ•'â†©ï¸ ğŸ”¨ ğŸ‚ğŸ’¾ğŸ‚
		ğŸ’©ğŸ’©ğŸ’©â–ªï¸sortâ–ªï¸each ğŸ”¨ ğŸ‚ğŸŠğŸ‚
			ğŸ’¾â–ªï¸ğŸ‘€â†ªï¸ğŸŠâ†©ï¸
		ğŸ”š
	ğŸ”š

	begin
		ğŸ’©ğŸ’©ğŸ’© ğŸ”¨ ğŸ‚ğŸŠğŸ‚
			ğŸ¦â–ªï¸blockâ†ªï¸ğŸŠâ–ªï¸to_iâ†©ï¸
			ğŸ‘€ ğŸ’¬ğŸš«ğŸŠ: #âªğŸŠâ©ğŸ’¬
		ğŸ”š
	rescue Twitter::Error::NotFound => error
		ğŸ‘€ ğŸ’¬âš ï¸: ğŸŠ not found: #âªğŸŠâ©ğŸ’¬
	rescue Twitter::Error::Forbidden => error
		ğŸ‘€ ğŸ’¬âš ï¸: ğŸŠ suspğŸ”šed: #âªğŸŠâ©ğŸ’¬
	rescue Twitter::Error::TooManyRequests => error
		ğŸ‘€ ğŸ’¬ğŸ˜´ğŸ˜´ğŸ˜´ğŸ˜´ğŸ˜´ API limit reachedâ° sleeping #âªerrorâ–ªï¸rate_limitâ–ªï¸reset_inâ© secondsâ–ªï¸ ğŸ˜´ğŸ˜´ğŸ˜´ğŸ˜´ğŸ˜´ğŸ’¬
		sleep errorâ–ªï¸rate_limitâ–ªï¸reset_in â• 1ï¸âƒ£
		retry
	ğŸ”š
ğŸ”š

ğŸ’­ main logic
ğŸ”œ main
	ğŸ“– = ğŸ“šâ†ªï¸CONFIG_FILEâ†©ï¸

	ğŸ’­ set up our session directory
	if Dirâ–ªï¸exist?â†ªï¸LOGDIRâ†©ï¸
		ğŸ‘€ ğŸ’¬#âªLOGDIRâ© already existsâ° exitingâ–ªï¸ğŸ’¬
		exit
	else
		FileUtilsâ–ªï¸mkdir_pâ†ªï¸LOGDIRâ†©ï¸
	ğŸ”š

	ğŸ‘€ ğŸ’¬ğŸ“ğŸš«ğŸŠâ–ªï¸ğŸ’¬
	ğŸ“ğŸš«ğŸŠ = ğŸš«â†ªï¸ğŸ“–â†©ï¸

	ğŸ‘€ ğŸ’¬ğŸ©ğŸŠ ğŸ“ ğŸ‘¶ğŸŠâ–ªï¸ğŸ’¬
	ğŸ‘ğŸ‘ğŸ‘ = ğŸ™‡â†ªï¸ğŸ“–â†©ï¸

	ğŸ‘€ ğŸ’¬ğŸ“ ğŸŠâ–ªï¸ğŸ’¬
	ğŸ’©ğŸ’©ğŸ’© = ğŸ“ğŸ™‡ğŸŠâ†ªï¸ğŸ“–â° ğŸ“ğŸš«ğŸŠâ° ğŸ‘ğŸ‘ğŸ‘â†©ï¸

	ğŸ‘€ ğŸ’¬ğŸ¦ğŸš« #âªğŸ’©ğŸ’©ğŸ’©â–ªï¸sizeâ© ğŸŠâ–ªï¸ğŸ’¬
	ğŸ˜­ğŸ’©ğŸŠâ†ªï¸ğŸ’©ğŸ’©ğŸ’©â†©ï¸
ğŸ”š

main
