#!/usr/bin/env ruby

require 'twitter'
require 'yaml'
require 'fileutils'

CONFIG_FILE	= File.join(File.dirname(__FILE__), 'conf.yaml')
TIMESTAMP	= Time.now.strftime("%Y%m%d.%H%M%S")
LOGDIR		= File.join(File.dirname(__FILE__), 'run', TIMESTAMP)

# load our config file.
def ğŸ“š(ğŸ“˜)
	YAML.load_file(ğŸ“˜)
end


# create a new connection to twitter.
def ğŸ’»(ğŸ“–)
	Twitter::REST::Client.new(credentials = ğŸ“–[:twitter]) 
end

# get a list of our currently blocked users.
# theoretically, we can hit API limits with this, but w/e.
# it's more efficient than issuing a block call for an existing block. 
def ğŸš«(ğŸ“–)
	ğŸ¦ = ğŸ’»(ğŸ“–)
	ğŸ“ğŸš«ğŸŠ = Array.new

	begin
		ğŸš«ğŸ“¥ = ğŸ¦.blocked_ids
		File.open(File.join(LOGDIR, 'block_ids.current'), 'w+') do |ğŸ’¾|
			ğŸš«ğŸ“¥.sort.each do |ğŸ˜­ğŸŠ|
				ğŸ’¾.puts(ğŸ˜­ğŸŠ)
				ğŸ“ğŸš«ğŸŠ << ğŸ˜­ğŸŠ.to_s
			end
		end
	rescue Twitter::Error::TooManyRequests => error
		puts "ğŸ˜´ğŸ˜´ğŸ˜´ğŸ˜´ğŸ˜´ API limit reached, sleeping #{error.rate_limit.reset_in} seconds. ğŸ˜´ğŸ˜´ğŸ˜´ğŸ˜´ğŸ˜´"
		sleep error.rate_limit.reset_in + 1
		retry
	end

	ğŸ“ğŸš«ğŸŠ
end


# pull down follower lists
def ğŸ™‡(ğŸ“–)
	ğŸ¦ = ğŸ’»(ğŸ“–)
	ğŸ‘ğŸ‘ğŸ‘ = {}

	ğŸ“–[:sourcelist].each do |ğŸ©ğŸŠ|
		puts "Getting ğŸ‘ğŸ‘ğŸ‘ for ğŸ©ğŸŠ: #{ğŸ©ğŸŠ}"

		begin
			File.open(File.join(LOGDIR, "followers.#{ğŸ©ğŸŠ}"), 'w+') do |ğŸ’¾|
				ğŸ™‡ğŸ™‡ğŸ™‡ = ğŸ¦.follower_ids(ğŸ©ğŸŠ.to_i)
				ğŸ™‡ğŸ™‡ğŸ™‡.sort.each do |ğŸ‘¶ğŸŠ|
					ğŸ‘ğŸ‘ğŸ‘[ğŸ‘¶ğŸŠ.to_s] = ğŸ‘ğŸ‘ğŸ‘.has_key?(ğŸ‘¶ğŸŠ.to_s) ? ğŸ‘ğŸ‘ğŸ‘[ğŸ‘¶ğŸŠ.to_s] + 1 : 1 
					ğŸ’¾.puts(ğŸ‘¶ğŸŠ)
				end
			end
		rescue Twitter::Error::Unauthorized => error
			puts "âš ï¸: ğŸŠ unauthorized: #{ğŸŠ}"
		rescue Twitter::Error::TooManyRequests => error
			puts "API limit reached, sleeping #{error.rate_limit.reset_in} seconds"
			sleep error.rate_limit.reset_in + 1
			retry
		end
	end

	ğŸ‘ğŸ‘ğŸ‘
end


# look at our list of followers & determine which need to be blocked.
def ğŸ“ğŸ™‡ğŸŠ(ğŸ“–, ğŸ“ğŸš«ğŸŠ, ğŸ‘ğŸ‘ğŸ‘)
	ğŸ¦ = ğŸ’»(ğŸ“–)
	ğŸ’©ğŸ’©ğŸ’© = Array.new

	ğŸ‘ğŸ‘ğŸ‘.each do | ğŸŠ, ğŸ™‡ |
		next if ğŸ™‡ < 2
		next if ğŸ“–[:whitelist].include? ğŸŠ.to_i
		next if ğŸ“ğŸš«ğŸŠ.include? ğŸŠ.to_s

		ğŸ’©ğŸ’©ğŸ’© << ğŸŠ
	end

	ğŸ’©ğŸ’©ğŸ’©
end

def ğŸ˜­ğŸ‘ğŸ’©ğŸŠ(ğŸ“–, ğŸ’©ğŸ’©ğŸ’©)
	ğŸ¦ = ğŸ’»(ğŸ“–)

	File.open(File.join(LOGDIR, 'block_ids.new'), 'w+') do |ğŸ’¾|
		ğŸ’©ğŸ’©ğŸ’©.sort.each do |ğŸŠ|
			ğŸ’¾.puts(ğŸŠ)
		end
	end

	begin
		ğŸ’©ğŸ’©ğŸ’© do |ğŸŠ|
			ğŸ¦.block(ğŸŠ.to_i)
			puts "ğŸš«ğŸŠ: #{ğŸŠ}"
		end
	rescue Twitter::Error::NotFound => error 
		puts "âš ï¸: ğŸŠ not found: #{ğŸŠ}"
	rescue Twitter::Error::Forbidden => error
		puts "âš ï¸: ğŸŠ suspended: #{ğŸŠ}"
	rescue Twitter::Error::TooManyRequests => error
		puts "ğŸ˜´ğŸ˜´ğŸ˜´ğŸ˜´ğŸ˜´ API limit reached, sleeping #{error.rate_limit.reset_in} seconds. ğŸ˜´ğŸ˜´ğŸ˜´ğŸ˜´ğŸ˜´"
		sleep error.rate_limit.reset_in + 1
		retry
	end
end

# main logic
def main
	ğŸ“– = ğŸ“š(CONFIG_FILE)

	# set up our session directory 
	if Dir.exist?(LOGDIR)
		puts "#{LOGDIR} already exists, exiting."
		exit
	else
		Dir.mkdir(LOGDIR)
	end

	puts "ğŸ“ğŸš«ğŸŠ."
	ğŸ“ğŸš«ğŸŠ = ğŸš«(ğŸ“–)

	puts "ğŸ©ğŸŠ ğŸ“ ğŸ‘¶ğŸŠ."
	ğŸ‘ğŸ‘ğŸ‘ = ğŸ™‡(ğŸ“–)

	puts "ğŸ“ ğŸŠ."
	ğŸ’©ğŸ’©ğŸ’© = ğŸ“ğŸ™‡ğŸŠ(ğŸ“–, ğŸ“ğŸš«ğŸŠ, ğŸ‘ğŸ‘ğŸ‘)

	puts "ğŸ¦ğŸš« #{ğŸ’©ğŸ’©ğŸ’©.size} ğŸŠ."
	ğŸ˜­ğŸ‘ğŸ’©ğŸŠ(ğŸ’©ğŸ’©ğŸ’©)
end

main
